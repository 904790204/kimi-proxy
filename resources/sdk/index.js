!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function t(t){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?e(Object(r),!0).forEach((function(e){o(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):e(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function n(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,r(o.key),o)}}function o(e,t,n){return(t=r(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,t||"default");if("object"!=typeof o)return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}var i,a,s="kimiproxy_pageid",c="start",u="close",l="log",d="info",f="element",p="storage",g="visible",m="hidden",h=[],y=function(e){h.push(e),i&&clearTimeout(i),i=setTimeout((function(){sendMessage({logs:h,type:l}),h.splice(0,h.length)}),500)},v=function(e){return-1!==(null==e?void 0:e.indexOf(".js"))||-1!==(null==e?void 0:e.indexOf(".css"))||-1!==(null==e?void 0:e.indexOf(".html"))||-1!==(null==e?void 0:e.indexOf(".ts"))},w=function(){function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.instance=null,this.queue=[],document.addEventListener("visibilitychange",(function(){t.queue.forEach((function(e){e("visible"===document.visibilityState)}))}),!1)}var t,o,r;return t=e,r=[{key:"getInstance",value:function(){return this.instance||(this.instance=new e),this.instance}}],(o=[{key:"listenStatus",value:function(e){this.queue.push(e)}}])&&n(t.prototype,o),r&&n(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}(),b=["log","debug","info","warn","error","table","clear","time","timeEnd","count","assert","command","result","dir"],S={},O=function(){for(var e=localStorage.length,t={},n=0;n<e;n++){var o=localStorage.key(n),r=localStorage.getItem(o);t[o]=r}return pConsole.log("LocalStorage: ",t),t},j=function(){for(var e=sessionStorage.length,t={},n=0;n<e;n++){var o=sessionStorage.key(n),r=sessionStorage.getItem(o);t[o]=r}return pConsole.log("SessionStorage: ",t),t},E=function(){var e=function(){for(var e={},t=document.cookie.split(";"),n=0;n<t.length;n++){var o=t[n].trim().split("="),r=o[0],i=decodeURIComponent(o[1]);e[r]=i}return pConsole.log("cookies: ",e),e}(),t=O(),n=j();sendMessage({type:p,info:{cookie:e,localStorage:t,sessionStorage:n}})},I=new Uint8Array(16);function M(){if(!a&&!(a="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return a(I)}for(var C=[],k=0;k<256;++k)C.push((k+256).toString(16).slice(1));var P={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function L(e,t,n){if(P.randomUUID&&!t&&!e)return P.randomUUID();var o=(e=e||{}).random||(e.rng||M)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){n=n||0;for(var r=0;r<16;++r)t[n+r]=o[r];return t}return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(C[e[t+0]]+C[e[t+1]]+C[e[t+2]]+C[e[t+3]]+"-"+C[e[t+4]]+C[e[t+5]]+"-"+C[e[t+6]]+C[e[t+7]]+"-"+C[e[t+8]]+C[e[t+9]]+"-"+C[e[t+10]]+C[e[t+11]]+C[e[t+12]]+C[e[t+13]]+C[e[t+14]]+C[e[t+15]]).toLowerCase()}(o)}var U,x="x-kimi-pageid",q="x-kimi-reqid",D=function(e){if(!e)return!1;return/^\/\/\d+?\.\d+?\.\d+?\.\d+?/.test(e)},H=function(){if(window.XMLHttpRequest){var e=sessionStorage.getItem(s),t=window.XMLHttpRequest.prototype.open;window.XMLHttpRequest.prototype.open=function(n,o,r){var i=this,a=i.onreadystatechange||function(){};return i.addEventListener("readystatechange",(function(){if(0===i.readyState);else if(1===i.readyState){if(o&&("string"==typeof o||o instanceof String)){var t=!v(o),n=L();t&&!D(o)&&(i.setRequestHeader(q,n),i.setRequestHeader(x,e))}}else 2===i.readyState||3===i.readyState||i.readyState;return a.apply(i,arguments)})),t.apply(i,arguments)}}},N=function(){var e=sessionStorage.getItem(s),n=fetch;Object.defineProperty(window,"fetch",{configurable:!0,enumerable:!0,get:function(){return function(r,i){var a,s,c,u=L();v(r)||D(r)||(i?i.headers=t(t({},null===(a=i)||void 0===a?void 0:a.headers),{},(o(s={},q,u),o(s,x,e),s)):i={headers:(c={},o(c,q,u),o(c,x,e),c)});return new Promise((function(e,o){n(r,t({},i)).then((function(t){e(t)})).catch((function(e){o(e)}))}))}},set:function(){}})};U=sessionStorage.getItem(s)||window[s],window[s]=U,sessionStorage.setItem(s,U),new Promise((function(e,n){var o=new WebSocket("wss://kimiproxy.takim.cn/local/debug/log");o.onopen=function(){window.sendMessage=function(e){var n=t(t({},e),{},{pageId:window[s],time:(new Date).getTime()});o.send(JSON.stringify(n))},sendMessage({type:c}),e()},o.onmessage=function(e){},o.onclose=function(e){sendMessage({event:e,type:u})},o.onerror=function(e){sendMessage({event:e,type:u}),n()},window.onbeforeunload=function(){sendMessage({type:u}),o.close()}})).then((function(){!function(){for(var e=function(){var e=n[t],o=window.console;S[e]=o[e],o[e]=function(){S[e].apply(this,arguments);var t=[].slice.call(arguments);y({subclass:"console",method:e,data:t})}},t=0,n=b;t<n.length;t++)e();window.pConsole=S}(),pConsole.log("kimiproxy_pageid",U),function(){var e=window.navigator,t=e.appCodeName,n=e.appName,o=e.appVersion,r=e.userAgent,i="other";(r.match(/compatible/i)||r.match(/Windows/i))&&(i="windows"),(r.match(/Macintosh/i)||r.match(/MacIntel/i))&&(i="macOS"),(r.match(/iphone/i)||r.match(/Ipad/i))&&(i="ios"),r.match(/android/i)&&(i="android");var a={system:i,appCodeName:t,appName:n,appVersion:o,width:window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,height:window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,hostname:location.hostname,pathname:location.pathname,href:location.href};sendMessage({type:d,info:a}),pConsole.log(d,a)}(),window.addEventListener("error",(function(e){var t;e.error instanceof Error&&(pConsole.log("jsError",e),y({subclass:"jsError",message:e.message,stack:(null===(t=e.error)||void 0===t?void 0:t.stack)||""}));var n=e.target||e.srcElement;if(n instanceof HTMLElement&&-1!==["LINK","SCRIPT","IMG"].indexOf(n.nodeName)){var o=n.src||n.href;0!==window.location.href.indexOf(o)&&(pConsole.log("resourceError",e,e.target.src),y({subclass:"resourceError",message:e.message,tagName:e.target.tagName,src:e.target.src}))}}),!0),window.addEventListener("unhandledrejection",(function(e){pConsole.log("unhandledrejection",e.reason),y({subclass:"unhandledrejection",reason:e.reason})})),E(),H(),N(),window.onload=function(){sendMessage({type:f,html:document.documentElement.outerHTML});var e=document.querySelector("html");pConsole.log(111111111,e),new MutationObserver((function(e,t){pConsole.log(e),pConsole.log(t),pConsole.log(111111111),sendMessage({type:f,mutationsList:e,observer:t})})).observe(e,{attributes:!0,childList:!0,subtree:!0,attributeOldValue:!0})}})),w.getInstance().listenStatus((function(e){sendMessage({type:e?g:m})}))}));
